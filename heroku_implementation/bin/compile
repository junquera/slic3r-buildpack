#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# TODO Ver si meter en carpeta propia
BIN_PATH="$BUILD_DIR/bin"
LIB_PATH="$BUILD_DIR/lib"
TMP_PATH="$BUILD_DIR/tmp"
mkdir -p $CACHE_DIR $BIN_PATH $LIB_PATH $TMP_PATH

SLIC3R_URL="https://github.com/prusa3d/Slic3r/releases/download/version_1.41.0/Slic3rPE-1.41.0+linux64-full-201809010758.tar.bz2"
SLIC3R_TAR="$CACHE_DIR/slic3r.tar.bz2"
SLIC3R_PATH="$TMP_PATH/Slic3rPE-1.41.0+linux64-full-201809010758"
SLIC3R_BINARIES="$SLIC3R_PATH/bin"
SLIC3R_LIBS="$SLIC3R_PATH/lib"
SLIC3R_RESOURCES="$SLIC3R_PATH/resources"

if [ -f $SLIC3R_TAR ]; then
  echo "-----> Using slic3r tar from cache"
else
  echo "-----> Downloading Prusa's Slic3r"
  curl -L $SLIC3R_URL -o $SLIC3R_TAR
fi

echo "-----> Unpacking..."
bzip2 -cd $SLIC3R_TAR | tar xvf - -C $TMP_PATH

echo "-----> Moving binaries to the right place"
mv $SLIC3R_PATH/slic3r $BUILD_PATH/
mv $SLIC3R_PATH/slic3r.pl $BULD_PATH/
mv $SLIC3R_BINARIES/* $BIN_PATH/

echo "-----> Moving libs to the right place"
mv $SLIC3R_LIBS/* $LIB_PATH/

echo "-----> Cleaning up"
rm -rf $SLIC3R_PATH

echo "-----> Installing slic3r resources"
# TODO Ver qu√© hacer con SLIC3R_RESOURCES="$SLIC3R_PATH/resources"
# TODO Ver ruta /app/.heroku/vendor/lib
